<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dataviz Accès Ouvert Empilé</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
</head>
<body style="background-color: #f4f4f9; padding: 20px; font-family: sans-serif;">
    <div id="chart-container" style="width:100%; height:600px; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>

    <script type="text/javascript">
        var chartDom = document.getElementById('chart-container');
        var myChart = echarts.init(chartDom);

        // Couleurs thématiques pour la répartition
        const colorMap = {
            "Gold": "#fac858",
            "Green": "#91cc75",
            "Diamond": "#73c0de",
            "Hybrid": "#ee6666",
            "Bronze": "#fc8452",
            "Other": "#7b7b7b",
            "default": "#9a60b4"
        };

        const years = ["2022", "2023", "2024", "2025"];
        const totalPubs = [500, 620, 750, 400];
        const oaPubs = [300, 450, 580, 310];
        
        // Calcul du reste (Accès fermé) pour l'empilement
        const closedPubs = totalPubs.map((t, i) => t - oaPubs[i]);

        const oaDetails = [
            {"Green": 50, "Diamond": 40, "Gold": 60, "Hybrid": 30, "Bronze": 20, "Other": 10, "Diamond,Green": 20, "Gold,Green": 30, "Hybrid,Green": 20, "Bronze,Green": 10, "Other,Green": 10},
            {"Green": 60, "Diamond": 55, "Gold": 80, "Hybrid": 40, "Bronze": 25, "Other": 15, "Diamond,Green": 45, "Gold,Green": 60, "Hybrid,Green": 35, "Bronze,Green": 20, "Other,Green": 15},
            {"Green": 70, "Diamond": 90, "Gold": 110, "Hybrid": 50, "Bronze": 30, "Other": 20, "Diamond,Green": 60, "Gold,Green": 70, "Hybrid,Green": 40, "Bronze,Green": 25, "Other,Green": 15},
            {"Green": 40, "Diamond": 50, "Gold": 60, "Hybrid": 30, "Bronze": 15, "Other": 10, "Diamond,Green": 30, "Gold,Green": 40, "Hybrid,Green": 20, "Bronze,Green": 15, "Other,Green": 10}
        ];

        var option = {
            title: { text: "Nombre de publications par année et type d'accès", left: 'center', top: 20 },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function (params) {
                    var idx = params[0].dataIndex;
                    var yearDetail = oaDetails[idx];
                    var total = totalPubs[idx];
                    var oa = oaPubs[idx];
                    var percent = ((oa / total) * 100).toFixed(1);

                    var html = `<div style="font-weight:bold; margin-bottom:5px;">Année ${params[0].name}</div>`;
                    html += `<div style="margin-bottom:5px;">Total Publications : <b>${total}</b></div>`;
                    html += `<div style="color:#91cc75; font-weight:bold;">Accès Ouvert : ${oa} (${percent}%)</div>`;
                    html += '<div style="margin-top:8px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px;">';
                    
                    for (var key in yearDetail) {
                        // On cherche une couleur dans la map, sinon couleur par défaut
                        let colorKey = key.split(',')[0]; 
                        let color = colorMap[colorKey] || colorMap["default"];
                        
                        html += `<div style="display:flex; align-items:center;">
                                    <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:${color}; margin-right:5px;"></span>
                                    <span>${key}: <b>${yearDetail[key]}</b></span>
                                 </div>`;
                    }
                    html += '</div>';
                    return `<div style="min-width:250px;">${html}</div>`;
                }
            },
            legend: { data: ['Accès Ouvert', 'Accès Fermé'], bottom: 10 },
            xAxis: { type: 'category', data: years },
            yAxis: { type: 'value', name: 'Nombre de publications' },
            series: [
                {
                    name: 'Accès Ouvert',
                    type: 'bar',
                    stack: 'total', // Même nom de stack pour empiler
                    data: oaPubs,
                    itemStyle: { color: '#91cc75' },
                    label: {
                        show: true,
                        position: 'inside',
                        formatter: function(p) {
                            return Math.round((p.value / totalPubs[p.dataIndex]) * 100) + '%';
                        }
                    }
                },
                {
                    name: 'Accès Fermé',
                    type: 'bar',
                    stack: 'total',
                    data: closedPubs,
                    itemStyle: { color: '#5470c6' }
                }
            ]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());
    </script>
</body>
</html>